#!/bin/bash
typeset -a FIELDS=()

for node in $@; do
 FIELDS+=("--field-selector=spec.nodeName=$node")
done	

#echo fields: ${FIELDS[@]}

# the following jq was developed with the help of OpenAI o4-mini
oc get pods --all-namespaces ${FIELDS[@]} -o json | jq -r '
  # Build a flat list of {node, gpus} entries
  [ .items[]
    | . as $pod
    | .spec.containers[]? as $ctr
    | select($ctr.resources.requests["nvidia.com/gpu"] != null)
    | { node: $pod.spec.nodeName,
        gpus: ($ctr.resources.requests["nvidia.com/gpu"] | tonumber)
      }
  ]
  # Group those entries by node
  | group_by(.node)
  # For each node‐group, sum the gpus
  | map({
      node:  .[0].node,
      total: map(.gpus) | add
    })
  # And finally print “node: N GPUs”
  | map(
     select(.node != null)
     | if .total > 0
        then "\(.node): BUSY \(.total) GPU POD"
	else "\(.node): FREE"
	end
    )
  | .[]  
'
